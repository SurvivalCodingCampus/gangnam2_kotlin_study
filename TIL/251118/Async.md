# 비동기 프로그래밍

## 동기 vs 비동기
- 작업 완료를 기다리는 방식의 차이
- 동기 : 한 작업이 끝날 때까지 기다렸다가 다음 작업 시작
- 비동기 : 기다리지 않고 다른 작업 시작

### 동기 (Synchronous) 프로그래밍
- 코드 순서대로 실행
- 작업 완료될 때까지 프로그램 중단 못함
- 모든 작업은 이전 작업의 실행이 완료될 때까지 기다려야함
- 코드의 실행 순서가 예측가능

### 비동기 (Asynchronous) 프로그래밍
- 여러 작업이 병렬로 실행됨
- 한 작업이 완료 여부와 관계없이 다음 작업 시작가능
- 작업의 완료 순서 예측 못함
- I/O 작업이나 네트워크 요청과 같이 시간이 오래 걸리는 작업에 유용

## 동시성 vs 병렬성
- 여러 작업을 처리하는 방식에 대한 차이
- 동시성 : 여러 작업을 번갈아가면서 처리
- 병렬성 : 여러 작업을 실제로 동시에 처리

### 동시성 (Concurrency)
- 여러 작업이 논리적으로 동시에 실행되는 것처럼 보이는 개념
- 시분할 방식으로 여러 스레드를 활용해 동시성을 구현할 수 있음

### 병렬성 (Parallelism)
- 여러 작업이 물리적으로 동시에 실행되는 개념
- 멀티코어 환경에서 실제로 여러 스레드가 병렬로 실행될 수 있음

### 정리
- 하나의 교사가 여러가지 일을 하는 것 (싱글 코어) : 동시성
- 교사와 조교가 함께 일을 하는 것 (멀티 코어) : 병렬성
- 순서대로 실행하는 것 : 동기
- 동시에 실행하는 것 : 비동기 (동시성, 병렬성 모두 표현할 수 있음)

## 코루틴 (Coroutine)
- 코틀린에서는 쓰레드, 콜백, 퓨처 대신 코루틴을 쓴다.
- 경량 : 코루틴은 실행 중인 스레드를 차단하지 않는 정지(suspend)를 지원하여 메모리를 절약하면서 많은 동시 작업을 처리
- 메모리 누수 감소 : 스레드를 활용한 동기화는 휴먼 에러에 의한 메모리 누수나 데드락과 같은 위험이 존재하지만, 코루틴은 안전
- 콜백 기반 코드를 순차 코드로 변환할 수 있다
- 다른 언어의 async, await 같은 키워드가 제공하지 않음
- 대신 정지 함수를 활용한 안전하고 에러가 발생하지 않는 비동기 처리에 중점을 두고 있음 

### 코루틴 스코프
- 코루틴은 스코프에 의존적임 : 코루틴 스코프 안에서 코루틴을 시작할 수 있음
```kotlin
fun main() = runBlocking {
    launch{
        delay(1000)
        println("World!")
    }
    println("Hello")
}
```

### 코루틴 빌더
- 새로운 코루틴을 시작하는 함수
- runBlocking, withContext, ContextScope, launch, async 등
- 코루틴 빌더는 코루틴의 생명주기를 제한하는 CoroutineScope를 생성한다.
- launch 로 새로운 코루틴을 시작해도 독립적으로 동작하기 때문에 Hello 가 먼저 출력됨

1. launch : 결과가 필요없는 비동기 작업
2. async : 결과가 필요한 비동기 작업
3. runBlocking : 코루틴과 일반 코드 연결, Unit Test에서 사용
4. delay : suspend 함수는 일정 시간 코루틴을 일시 정지함. suspend 함수는 CoroutineScope 블록 또는 다른 suspend 함수에서 호출 가능
5. suspend : 비동기 함수를 표기하는 코틀린 문법. 함수가 실행되면 완료될 때까지 일시 중지. 그 사이 다른 함수나 코루틴 실행가능

### CoroutineScope 정리
- 모든 코루틴을 추적하여 코루틴이 실행되어야 하는 시기를 관리하는 구성요소
- 모든 비동기 작업은 특정 스코프에서 실행되어야 함
- 코루틴은 스코프에 의존적이다
- 적절한 스코프가 없으면 전역적인 스코프인 GlobalScope를 사용 가능 (비추천)

### 코루틴은 하나의 코루틴 안에서는 순차 실행
- suspend 함수 2개를 실행하면 순차적으로 실행 됨
- 병렬 실행은 async 코루틴 빌더와 await 함수를 이용

### Job
- CoroutineBuilder 에 의해 작성된 코루틴
- launch 는 Job을 리턴한다
- Job 을 통해 실행중인 코루틴을 제어할 수 있다
- Job 을 통해 코루틴 취소 가능

### Dispatcher
- 코루틴이 어떤 스케줄러에 의해 수행될지를 지정할 수 있다
- Default : 백그라운드 쓰레드, CPU 바운드
- Main : 메인 쓰레드에 연결되는 디스패치
- IO : 백그라운드 스레드, I/O 바운드
- Unconfined : 특정 스레드를 한정하지 않음. 공식 문서에서는 보통 사용하지 않는다고 명시되어 있음

### 정리
- Thread.sleep() 은 스레드를 차단(점유)하는 문제가 있음
- delay() 는 현재 실행되는 코드 블록을 일정 시간 쉬게하고 다른 코드 블록에 스레드를 쓸 기회를 줌 (중단 = suspend)
- Thread.sleep은 스레드를 소비하지만, delay는 양보한다
